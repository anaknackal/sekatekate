<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Formulir Investigasi Insiden Bertingkat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIBRARY UNTUK DOWNLOAD WORD DITAMBAHKAN DI SINI -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <style>
        /* Custom scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Style untuk radio button custom */
        .radio-group label { transition: all 0.2s ease-in-out; }
        .radio-group input[type="radio"]:checked + label { background-color: #3b82f6; color: white; border-color: #2563eb; }

        /* Utility untuk teks vertikal di sidebar */
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); }

        /* Transisi untuk kemunculan comment box */
        .comment-container { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; }
        .comment-container.visible { max-height: 200px; }
        .sub-options-container { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; }
        .sub-options-container.visible { max-height: 1500px; }

        /* Style untuk footer dan header yang sticky */
        footer {
            position: sticky;
            bottom: 0;
            z-index: 30;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-top: 1px solid #e5e7eb;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .sticky-sidebar {
            position: sticky;
            top: 0; /* Akan di-update oleh JS */
            height: 100vh; /* Akan di-update oleh JS */
        }
        
        /* Style untuk tombol bahasa aktif */
        .lang-switcher .active { font-weight: bold; text-decoration: underline; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- Tombol Pilihan Bahasa (Sticky) -->
    <div class="lang-switcher fixed top-4 right-4 z-50 bg-white/90 backdrop-blur-sm p-2 rounded-lg shadow-md text-gray-600 text-sm sm:text-base">
        <span id="btn-lang-id" class="cursor-pointer px-2 hover:text-blue-500">ID</span>|
        <span id="btn-lang-en" class="cursor-pointer px-2 hover:text-blue-500">EN</span>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h1 id="main-header" class="text-3xl font-bold text-gray-700 text-center pt-4"></h1>
            <p id="main-subtitle" class="text-center text-gray-500 mt-2"></p>
        </header>

        <main id="form-pages" class="bg-white p-6 md:p-8 rounded-xl shadow-md">

            <!-- Halaman 1: Jenis Kejadian -->
            <div id="page-1" class="page">
                <h2 id="p1-header" class="text-2xl font-semibold mb-2 text-blue-600"></h2>
                <p id="p1-subtitle" class="mb-6 text-gray-600"></p>
                <div class="mb-8">
                    <label id="p1-desc-label" for="description" class="block text-lg font-medium text-gray-700 mb-2"></label>
                    <textarea id="description" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                <div id="page-1-options" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Halaman 2, 3, 4, 5 akan di-generate di sini -->
            <div id="page-2" class="page hidden"></div>
            <div id="page-3" class="page hidden"></div>
            <div id="page-4" class="page hidden"></div>
            <div id="page-5" class="page hidden"></div>

        </main>

        <footer class="mt-8 flex justify-between items-center p-4">
            <div>
                <button id="back-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg"></button>
                <button id="reset-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg ml-2"></button>
            </div>
            <div id="step-indicator" class="text-gray-600 font-medium"></div>
            <button id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg"></button>
        </footer>
    </div>

    <div id="validation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 id="modal-header" class="text-xl font-bold text-red-600 mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button id="close-modal-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg"></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // ================================= //
            // === DATA & BAHASA === //
            // ================================= //
            const LANG_PACKS = {
                id: {
                    ui: {
                        pageTitle: "Formulir Investigasi Insiden Bertingkat", mainHeader: "Formulir Investigasi Insiden", mainSubtitle: "Silakan lengkapi setiap tahapan dengan cermat.",
                        p1: { header: "Tahap 1: Jenis Kejadian", subtitle: 'Isi deskripsi singkat insiden dan pilih satu atau beberapa "Jenis Kejadian" yang paling relevan.', descLabel: "Deskripsi Insiden", descPlaceholder: "Tuliskan kronologi dan detail insiden di sini..." },
                        p2: { header: "Tahap 2: Penyebab Langsung", descTitle: "Deskripsi Insiden:" },
                        p3: { header: "Tahap 3: Akar Masalah", descTitle: "Deskripsi Insiden:" },
                        p4: { header: "Tahap 4: Tindakan Perbaikan", descTitle: "Deskripsi Insiden:", correctiveAction: "Tindakan Perbaikan", pic: "Penanggung Jawab", targetDate: "Target Tanggal Selesai"},
                        p5: { header: "Tahap 5: Laporan Akhir" },
                        buttons: { sendEmail: "Kirim Laporan ke Email", downloadWord: "Download Laporan (Word)", back: "Kembali", next: "Lanjut", finish: "Selesai & Cetak", close: "Tutup", reset: "Atur Ulang" },
                        stepIndicator: (current, total) => `Langkah ${current} dari ${total}`,
                        modalHeader: "Peringatan",
                        radio: { yes: "YA", no: "TIDAK", na: "N/A" },
                        comments: { commentPlaceholder: "Komentar (wajib diisi jika memilih YA atau TIDAK)", subCommentPlaceholder: "Komentar (wajib)" },
                        report: { summaryMapTitle: "Peta Ringkasan Investigasi", incidentDesc: "Deskripsi Insiden", analysisTitle: "Analisis Rinci & Tindakan Perbaikan", eventType: "Jenis Kejadian", directCause: "Penyebab Langsung", rootCause: "Akar Masalah", comment: "Komentar:", subChoiceDetails: "Detail Sub-Pilihan:", correctiveAction: "Tindakan Perbaikan:", pic: "Penanggung Jawab:", target: "Target:", noDirectCause: "Tidak ada Penyebab Langsung yang relevan untuk dianalisis lebih lanjut dari kejadian ini.", noAnalysis: "Tidak ada data analisis untuk ditampilkan." }
                    },
                    validation: { descRequired: "Kolom deskripsi insiden wajib diisi.", eventRequired: 'Anda harus memilih minimal satu "Jenis Kejadian" untuk melanjutkan.', commentRequired: "Harap isi semua kolom komentar yang wajib (untuk pilihan YA atau TIDAK).", subCommentRequired: "Harap isi semua kolom komentar sub-pilihan yang wajib.", actionRequired: "Harap isi semua kolom Tindakan Perbaikan yang wajib." },
                    alerts: { email: "Fungsionalitas pengiriman email memerlukan backend.", word: "Fungsionalitas download Word memerlukan library tambahan." },
                    appData: {
                        page1Options: ["Terbentur/Menabrak (Berlari / Menubruk / Bertabrakan / Kandas / Hancur)", "Tertabrak oleh (Terkena Benda Bergerak)", "Jatuh dari Ketinggian (Orang/Peralatan/Material)", "Jatuh di Permukaan Datar (Terpeleset dan Jatuh/Tersandung)", "Terjepit di Dalam, di Atas, di Antara, atau di Bawah", "Kontak dengan Suhu Ekstrem (Panas/Dingin)", "Kontak dengan Listrik", "Paparan Kebisingan", "Paparan Getaran", "Paparan Radiasi Pengion", "Tegangan Mekanis Berlebih (karena Beban Berlebih/Tekanan Berlebih)", "Kontak dengan Zat/Dosis Berbahaya", "Kehilangan Penahanan Primer", "Pelepasan ke Lingkungan (ke Udara/Air/Tanah)", "Kebakaran (Pool Fire/Jet Fire/Flash Fire)", "Ledakan (Awan Uap/Debu/Letusan Tekanan/BLEVE)", "Kegagalan Peralatan Mekanis", "Kegagalan Sistem Kelistrikan", "Kegagalan Instrumentasi/Logika/Loop", "Kegagalan Struktur Sipil", "Operasi Abnormal/Gangguan Proses", "Proses/Reaksi Tidak Stabil", "Keluhan Pelanggan/Pemangku Kepentingan", "Tindak Kekerasan"],
                        page2Options: [{ id: 1, text: "(Perilaku Tidak Aman) Apakah peralatan dioperasikan dengan wewenang yang semestinya?" }, { id: 2, text: "(Perilaku Tidak Aman) Apakah informasi/peringatan diberikan secara efektif?" }, { id: 3, text: "(Perilaku Tidak Aman) Apakah semuanya diamankan dengan benar?" }, { id: 4, text: "(Perilaku Tidak Aman) Apakah peralatan dioperasikan pada kecepatan yang benar?" }, { id: 5, text: "(Perilaku Tidak Aman) Apakah perangkat keselamatan kritis berfungsi?" }, { id: 6, text: "(Perilaku Tidak Aman) Apakah perkakas/peralatan/mesin/perangkat dalam kondisi baik?" }, { id: 7, text: "(Perilaku Tidak Aman) Apakah perkakas/peralatan/mesin/perangkat dioperasikan dengan benar?" }, { id: 8, text: "(Perilaku Tidak Aman) Apakah servis peralatan/mesin yang sedang beroperasi sudah memadai?" }, { id: 9, text: "(Perilaku Tidak Aman) Apakah material yang digunakan sudah benar/sesuai?" }, { id: 10, text: "(Perilaku Tidak Aman) Apakah Alat Pelindung Diri digunakan dengan benar?" }, { id: 11, text: "(Perilaku Tidak Aman) Apakah pemuatan dilakukan dengan benar?" }, { id: 12, text: "(Perilaku Tidak Aman) Apakah penempatan dilakukan dengan benar?" }, { id: 13, text: "(Perilaku Tidak Aman) Apakah pengangkatan dilakukan dengan benar?" }, { id: 14, text: "(Perilaku Tidak Aman) Apakah posisi untuk tugas tersebut sudah sesuai?" }, { id: 15, text: "(Perilaku Tidak Aman) Apakah perilaku sudah sesuai?" }, { id: 16, text: "(Perilaku Tidak Aman) Apakah terbebas dari pengaruh obat/alkohol/narkoba?" }, { id: 17, text: "(Perilaku Tidak Aman) Apakah prosedur/instruksi diikuti?" }, { id: 18, text: "(Perilaku Tidak Aman) Apakah bahaya telah diidentifikasi?" }, { id: 19, text: "(Perilaku Tidak Aman) Apakah tindakan oleh pihak eksternal sudah standar/dapat diterima (di bawah kendali sendiri)?" }, { id: 20, text: "(Perilaku Tidak Aman) Apakah persyaratan pelanggan/pemangku kepentingan telah diidentifikasi?" }, { id: 21, text: "(Perilaku Tidak Aman) Apakah persyaratan pelanggan/pemangku kepentingan dipatuhi?" }, { id: 22, text: "(Perilaku Tidak Aman) Apakah ada ketertiban sipil (tidak ada kerusuhan, keresahan, perang)?" }, { id: 23, text: "(Perilaku Tidak Aman) Apakah tidak ada aktivitas kriminal?" }, { id: 24, text: "(Kondisi Tidak Aman) Apakah kondisi lantai/permukaan memadai?" }, { id: 25, text: "(Kondisi Tidak Aman) Apakah perkakas/peralatan bebas dari cacat?" }, { id: 26, text: "(Kondisi Tidak Aman) Apakah perkakas/peralatan sudah benar dan memadai?" }, { id: 27, text: "(Kondisi Tidak Aman) Apakah integritas peralatan memadai?" }, { id: 28, text: "(Kondisi Tidak Aman) Apakah deteksi/pengukuran dilakukan secara efektif?" }, { id: 29, text: "(Kondisi Tidak Aman) Apakah konversi pengukuran/sinyal sudah benar?" }, { id: 30, text: "(Kondisi Tidak Aman) Apakah material yang digunakan sudah benar?" }, { id: 31, text: "(Kondisi Tidak Aman) Apakah komposisi material/gas sudah benar?" }, { id: 32, text: "(Kondisi Tidak Aman) Apakah pelindung/penghalang memadai?" }, { id: 33, text: "(Kondisi Tidak Aman) Apakah Alat Pelindung Diri memadai/sesuai?" }, { id: 34, text: "(Kondisi Tidak Aman) Apakah ada ruang yang cukup/tidak terbatas untuk bergerak?" }, { id: 35, text: "(Kondisi Tidak Aman) Apakah sistem peringatan memadai?" }, { id: 36, text: "(Kondisi Tidak Aman) Apakah atmosfer bebas dari bahan yang mudah terbakar/meledak?" }, { id: 37, text: "(Kondisi Tidak Aman) Apakah bahan berbahaya hanya ada dengan otorisasi?" }, { id: 38, text: "(Kondisi Tidak Aman) Apakah kebersihan/ketertiban terpelihara dengan baik?" }, { id: 39, text: "(Kondisi Tidak Aman) Apakah tingkat kebisingan berada dalam ambang batas?" }, { id: 40, text: "(Kondisi Tidak Aman) Apakah bahaya radiasi berada dalam ambang batas?" }, { id: 41, text: "(Kondisi Tidak Aman) Apakah penerangan cukup dan tidak berlebihan?" }, { id: 42, text: "(Kondisi Tidak Aman) Apakah getaran berada dalam ambang batas?" }, { id: 43, text: "(Kondisi Tidak Aman) Apakah suhu berada dalam batas wajar?" }, { id: 44, text: "(Kondisi Tidak Aman) Apakah tekanan berada dalam batas wajar?" }, { id: 45, text: "(Kondisi Tidak Aman) Apakah ventilasi memadai?" }, { id: 46, text: "(Kondisi Tidak Aman) Apakah informasi memadai?" }, { id: 47, text: "(Kondisi Tidak Aman) Apakah paparan terhadap kondisi cuaca buruk dihindari/dikelola?" }],
                        page3Options: [ { id: 1, text: "Apakah kemampuan fisik/fisiologis memadai?", subOptions: ["Tinggi/berat/ukuran/kekuatan/jangkauan yang tidak sesuai, dll", "Rentang gerak tubuh terbatas", "Kemampuan terbatas/tidak mampu mempertahankan posisi tubuh", "Sensitivitas/alergi zat", "Sensitivitas terhadap sensorik ekstrem (suhu/suara/dll.)", "Kekurangan penglihatan", "Kekurangan pendengaran", "Kekurangan sensorik lainnya (sentuhan/rasa/bau/keseimbangan)", "Kapasitas pernapasan kurang", "Cacat fisik permanen lainnya", "Cacat sementara"] }, { id: 2, text: "Apakah kemampuan mental/psikologis memadai?", subOptions: ["Ketakutan dan fobia", "Gangguan emosional", "Penyakit mental", "Tingkat kecerdasan", "Ketidakmampuan untuk memahami", "Koordinasi yang buruk", "Waktu reaksi yang lambat", "Kecakapan mekanik yang rendah", "Kecakapan belajar yang rendah", "Kegagalan/kelemahan ingatan"] }, { id: 3, text: "Apakah stres fisik/fisiologis dikelola dengan baik?", subOptions: ["Cedera atau penyakit", "Kelelahan karena beban atau durasi tugas", "Kelelahan karena kurang istirahat", "Kelelahan karena kelebihan sensorik", "Paparan bahaya kesehatan", "Paparan suhu ekstrem", "Kekurangan oksigen", "Variasi tekanan atmosfer", "Gerakan terbatas", "Kekurangan gula darah", "Alkohol/Narkoba/Stres Akibat Diri Sendiri Lainnya"] }, { id: 4, text: "Apakah stres mental/psikologis dikelola dengan baik?", subOptions: ["Beban emosional berlebih", "Kelelahan karena beban atau kecepatan tugas mental", "Tuntutan penilaian/keputusan ekstrem", "Rutin/monoton/kebosanan/tugas yang terlalu rutin", "Tuntutan konsentrasi/persepsi ekstrem", "Aktivitas yang \"tidak berarti\"/\"merendahkan\"", "Arahan/tuntutan yang membingungkan", "Tuntutan/arahan yang bertentangan", "Terpaku pada masalah/Terganggu oleh kekhawatiran", "Frustrasi", "Penyakit mental"] }, { id: 5, text: "Apakah kompetensi mencukupi?", subOptions: ["Pengalaman tidak memadai", "Orientasi/induksi tidak memadai", "Pelatihan awal tidak memadai", "Pelatihan penyegaran/pembaruan tidak memadai", "Instruksi/informasi yang disalahpahami", "Kurangnya kesadaran situasional/persepsi risiko/kesadaran risiko", "Instruksi/pelatihan keterampilan awal tidak memadai", "Latihan tidak memadai", "Kinerja yang jarang", "Pembinaan tidak memadai", "Instruksi tinjauan tidak memadai"] }, { id: 6, text: "Apakah motivasi sudah benar?", subOptions: ["Kinerja/perilaku yang tidak pantas ditoleransi/dihargai", "Kinerja/perilaku yang pantas tidak dianjurkan/dihukum", "Kurangnya insentif", "Insentif produksi yang tidak pantas", "Insentif Pengurangan Biaya yang tidak pantas", "Frustrasi berlebihan", "Agresi yang tidak pantas", "Upaya yang tidak pantas untuk menghemat waktu/tenaga", "Upaya yang tidak pantas untuk menghindari ketidaknyamanan", "Upaya yang tidak pantas untuk mendapatkan perhatian", "Disiplin tidak memadai", "Tekanan teman sebaya yang tidak pantas", "Contoh kepemimpinan yang tidak pantas", "Umpan balik kinerja tidak memadai", "Penguatan perilaku yang benar tidak memadai", "Penyalahgunaan (disengaja)", "Penggunaan yang salah (tidak disengaja)"] }, { id: 7, text: "Apakah struktur organisasi jelas?", subOptions: ["Hubungan pelaporan yang tidak jelas/bertentangan", "Penugasan fungsi/peran yang tidak jelas/bertentangan", "Akuntabilitas/tanggung jawab/tugas yang tidak jelas/bertentangan"] }, { id: 8, text: "Apakah kepemimpinan memadai?", subOptions: ["Strategi K3LL/aset tidak memadai", "Pengembangan kepemimpinan tidak memadai", "Delegasi tidak memadai", "Standar tidak memadai", "Komunikasi/implementasi kebijakan/prosedur/praktik tidak memadai", "Kebijakan/prosedur/praktik yang bertentangan", "Perencanaan/pemrograman kerja/proses tidak memadai", "Memaafkan penyimpangan dari kebijakan/prosedur/praktik", "Memaafkan penyalahgunaan peralatan/perkakas", "Memaafkan perilaku yang tidak pantas/tidak semestinya", "Informasi manajemen tidak memadai", "Pemantauan/penutupan tindakan audit tidak memadai"] }, { id: 9, text: "Apakah pengawasan/pembinaan memadai?", subOptions: ["Instruksi/orientasi/pelatihan tidak memadai", "Dokumen informasi dalam pengawasan/pembinaan tidak memadai", "Kurangnya pengetahuan pekerjaan pengawasan/manajemen", "Kecocokan yang tidak memadai antara kualifikasi dan persyaratan pekerjaan/tugas", "Pengukuran dan evaluasi kinerja tidak memadai", "Umpan balik kinerja tidak memadai"] }, { id: 10, text: "Apakah perubahan dikelola secara efektif?", subOptions: ["Identifikasi bahaya/evaluasi risiko dalam desain tidak memadai", "Identifikasi mode kegagalan tidak memadai", "Evaluasi persyaratan pelanggan/pemangku kepentingan tidak memadai", "Identifikasi persyaratan hukum tidak memadai", "Pertimbangan faktor manusia/ergonomi dalam desain tidak memadai", "Proses/standar/spesifikasi/kriteria desain tidak memadai", "Otomatisasi kontrol proses tidak memadai", "Standar/spesifikasi (teknis) yang tidak memadai atau tidak adanya", "Tinjauan risiko proyek tidak memadai", "Pemantauan konstruksi/fabrikasi/perakitan tidak memadai", "Penilaian kesiapan operasional tidak memadai", "Proses komisioning/serah terima tidak memadai", "Pemantauan operasi awal tidak memadai", "Proses manajemen perubahan tidak memadai"] }, { id: 11, text: "Apakah manajemen rantai pasokan memadai?", subOptions: ["Spesifikasi pada permintaan/pesanan pembelian tidak memadai", "Penelitian tentang bahan/peralatan/perkakas/pasokan/dll tidak memadai", "Spesifikasi kepada vendor tidak memadai", "Mode/rute pengiriman tidak memadai", "Komunikasi informasi tentang bahaya tidak memadai", "Inspeksi/penerimaan barang tidak memadai", "Penanganan material yang tidak benar", "Penyimpanan material yang tidak benar", "Pengangkutan material yang tidak benar", "Masa simpan/validasi untuk penggunaan kembali bahan/peralatan tidak memadai", "Identifikasi material tidak memadai", "Penyelamatan/pembuangan limbah yang tidak benar", "Pemilihan kontraktor/pemasok tidak memadai"] }, { id: 12, text: "Apakah pemeliharaan/inspeksi memadai?", subOptions: ["Penilaian kebutuhan pemeliharaan preventif tidak memadai", "Pelumasan dan servis preventif tidak memadai", "Penyesuaian/perakitan tidak memadai", "Pembersihan/pelapisan ulang preventif tidak memadai", "Komunikasi kebutuhan pemeliharaan korektif tidak memadai", "Penjadwalan pekerjaan pemeliharaan tidak memadai", "Penilaian kebutuhan perbaikan tidak memadai", "Penggantian/substitusi suku cadang tidak memadai", "Metode/interval inspeksi tidak memadai", "Tidak dapat diinspeksi"] }, { id: 13, text: "Apakah keausan/kerusakan berada dalam batas yang dapat diterima?", subOptions: ["Perencanaan penggunaan tidak memadai", "Keputusan yang tidak tepat tentang perpanjangan masa pakai", "Inspeksi/pemantauan tidak memadai", "Pemuatan/tingkat penggunaan yang tidak tepat", "Digunakan untuk tujuan/tugas/aktivitas yang salah"] }, { id: 14, text: "Apakah perkakas/peralatan/mesin/perangkat memadai?", subOptions: ["Penilaian kebutuhan dan risiko tidak memadai", "Pertimbangan faktor manusia/ergonomi tidak memadai", "Standar/spesifikasi (pemasok) tidak memadai", "Pengukuran/deteksi/kontrol (proses) yang salah", "Ketersediaan perkakas/peralatan/mesin/perangkat tidak memadai", "Inspeksi/perbaikan/pemeliharaan tidak memadai", "Penyesuaian/kalibrasi tidak memadai", "Penghapusan dan penggantian barang yang tidak sesuai tidak memadai"] }, { id: 15, text: "Apakah desain produk/layanan efektif?", subOptions: ["Penilaian kebutuhan dan risiko tidak memadai", "Sistem standar/spesifikasi/konsesi produk/layanan tidak memadai", "Desain/pengembangan produk/layanan tidak memadai", "Standar produk/layanan tidak memadai", "Validasi desain produk/layanan tidak memadai", "Verifikasi desain produk/layanan tidak memadai", "Perencanaan produk/layanan tidak memadai", "Verifikasi kualitas produk/layanan tidak memadai"] }, { id: 16, text: "Apakah standar kerja/produksi memadai?", subOptions: ["Identifikasi persyaratan (peraturan/kode industri/izin operasi) tidak memadai", "Identifikasi/evaluasi risiko dalam pengembangan standar tidak memadai", "Standar dari pemasok/kontraktor tidak memadai", "Koordinasi dengan desain proses saat mengembangkan standar tidak memadai", "Keterlibatan karyawan dalam mengembangkan standar tidak memadai", "Standar yang bertentangan/prioritas standar yang tidak tepat", "Publikasi standar tidak memadai", "Distribusi standar tidak memadai", "Terjemahan bahasa yang sesuai tidak memadai", "Penggunaan bahasa yang tidak tepat", "Pelatihan standar tidak memadai", "Penguatan standar dengan rambu, kode warna, dan alat bantu kerja tidak memadai", "Pemantauan kepatuhan standar tidak memadai"] }, { id: 17, text: "Apakah komunikasi/informasi efektif?", subOptions: ["Penanganan informasi tidak memadai", "Informasi tidak jelas", "Transfer informasi antar proses/unit organisasi tidak memadai", "Transfer informasi dengan klien/pemangku kepentingan tidak memadai", "Transfer informasi dengan pihak berwenang tidak memadai", "Transfer informasi dengan pemasok/kontraktor/pihak ketiga tidak memadai", "Struktur komunikasi tidak memadai", "Database/sistem informasi tidak memadai", "Metode/teknik komunikasi yang digunakan tidak memadai"] }]
                    }
                },
                en: {
                    ui: {
                        pageTitle: "Tiered Incident Investigation Form", mainHeader: "Incident Investigation Form", mainSubtitle: "Please complete each stage carefully.",
                        p1: { header: "Step 1: Type of Event", subtitle: 'Fill in a brief incident description and select one or more relevant "Type of Event".', descLabel: "Incident Description", descPlaceholder: "Write the chronology and details of the incident here..." },
                        p2: { header: "Step 2: Direct Causes", descTitle: "Incident Description:" },
                        p3: { header: "Step 3: Root Causes", descTitle: "Incident Description:" },
                        p4: { header: "Step 4: Corrective Actions", descTitle: "Incident Description:", correctiveAction: "Corrective Action", pic: "Person in Charge", targetDate: "Target Completion Date" },
                        p5: { header: "Step 5: Final Report" },
                        buttons: { sendEmail: "Send Report to Email", downloadWord: "Download Report (Word)", back: "Back", next: "Next", finish: "Finish & Print", close: "Close", reset: "Reset" },
                        stepIndicator: (current, total) => `Step ${current} of ${total}`,
                        modalHeader: "Warning",
                        radio: { yes: "YES", no: "NO", na: "N/A" },
                        comments: { commentPlaceholder: "Comment (required if YES or NO is selected)", subCommentPlaceholder: "Comment (required)" },
                        report: { summaryMapTitle: "Investigation Summary Map", incidentDesc: "Incident Description", analysisTitle: "Detailed Analysis & Corrective Actions", eventType: "Type of Event", directCause: "Direct Cause", rootCause: "Root Cause", comment: "Comment:", subChoiceDetails: "Sub-Choice Details:", correctiveAction: "Corrective Action:", pic: "PIC:", target: "Target:", noDirectCause: "No relevant Direct Cause to analyze further for this event.", noAnalysis: "No analysis data to display." }
                    },
                    validation: { descRequired: "The incident description field is required.", eventRequired: 'You must select at least one "Type of Event" to continue.', commentRequired: "Please fill in all required comment fields (for YES or NO options).", subCommentRequired: "Please fill in all required sub-choice comment fields.", actionRequired: "Please fill in all required Corrective Action fields." },
                    alerts: { email: "Email functionality requires a backend.", word: "Word download functionality requires an additional library." },
                    appData: {
                        page1Options: ["Struck Against/Into (Running / Bumping / Colliding / Grounding / Crashing)", "Struck By (Hit By Moving Object)", "Fall from Elevation (Person/Equipment/Material)", "Fall on Same Level (Slip and Fall/Trip Over)", "Caught In, On, Between or Under", "Contact with Temperature Extremes (Heat/Cold)", "Contact with Electricity", "Exposure to Noise", "Exposure to Vibration", "Exposure to Ionising Radiation", "Mechanical Overstress (by Overload/Overpressure)", "Contact with Hazardous Substance/Dose", "Loss of Primary Containment", "Environmental Release (to Air/Water/Soil)", "Fire (Pool Fire/Jet Fire/Flash Fire)", "Explosion (Vapour Cloud/Dust/Pressure Burst/BLEVE)", "Failure of Mechanical Equipment", "Failure of Electrical System", "Failure of Instrumentation/Logic/Loop", "Failure of Civil Structure", "Abnormal Operation/Process Disturbance", "Unstable process/reaction", "Customers/Stakeholders Complaints", "Act of Violence"],
                        page2Options: [{ id: 1, text: "(UA) Is equipment operated with proper authority?" }, { id: 2, text: "(UA) Is information/warning provided effectively?" }, { id: 3, text: "(UA) Is everything properly secured?" }, { id: 4, text: "(UA) Is equipment operated at the correct speed?" }, { id: 5, text: "(UA) Are critical safety devices functional?" }, { id: 6, text: "(UA) Are tools/equipment/machinery/devices in good condition?" }, { id: 7, text: "(UA) Are tools/equipment/machinery/devices operated correctly?" }, { id: 8, text: "(UA) Is servicing of equipment/machinery in operation adequate?" }, { id: 9, text: "(UA) Is the correct/proper material being used?" }, { id: 10, text: "(UA) Is Personal Protective Equipment used properly?" }, { id: 11, text: "(UA) Is loading done properly?" }, { id: 12, text: "(UA) Is placement done properly?" }, { id: 13, text: "(UA) Is lifting done properly?" }, { id: 14, text: "(UA) Is the position for the task appropriate?" }, { id: 15, text: "(UA) Is behavior appropriate?" }, { id: 16, text: "(UA) Is anyone free from the influence of medicine/alcohol/drugs?" }, { id: 17, text: "(UA) Are procedures/instructions followed?" }, { id: 18, text: "(UA) Are hazards identified?" }, { id: 19, text: "(UA) Is the act by an external party standard/acceptable (under own control)?" }, { id: 20, text: "(UA) Are customer/stakeholder requirements identified?" }, { id: 21, text: "(UA) Are customer/stakeholder requirements complied with?" }, { id: 22, text: "(UA) Is there civil order (no riot, unrest, warfare)?" }, { id: 23, text: "(UA) Is there an absence of criminal activities?" }, { id: 24, text: "(UC) Is the condition of the floor/surface adequate?" }, { id: 25, text: "(UC) Are tools/equipment free of defects?" }, { id: 26, text: "(UC) Are tools/equipment correct and adequate?" }, { id: 27, text: "(UC) Is the integrity of the equipment adequate?" }, { id: 28, text: "(UC) Is detection/measurement performed effectively?" }, { id: 29, text: "(UC) Is measurement/signal conversion proper?" }, { id: 30, text: "(UC) Is the correct material used?" }, { id: 31, text: "(UC) Is the composition of material/gas correct?" }, { id: 32, text: "(UC) Is the guard/barrier adequate?" }, { id: 33, text: "(UC) Is Personal Protective Equipment adequate/proper?" }, { id: 34, text: "(UC) Is there sufficient/unrestricted space for action?" }, { id: 35, text: "(UC) Is the warning system adequate?" }, { id: 36, text: "(UC) Is the atmosphere free of flammable/explosive materials?" }, { id: 37, text: "(UC) Are hazardous materials present only with authorization?" }, { id: 38, text: "(UC) Is housekeeping/order well-maintained?" }, { id: 39, text: "(UC) Is the noise level within the threshold?" }, { id: 40, text: "(UC) Is the radiation hazard within the threshold?" }, { id: 41, text: "(UC) Is illumination sufficient and not excessive?" }, { id: 42, text: "(UC) Is vibration within the threshold?" }, { id: 43, text: "(UC) Is the temperature within limits?" }, { id: 44, text: "(UC) Is the pressure within limits?" }, { id: 45, text: "(UC) Is ventilation adequate?" }, { id: 46, text: "(UC) Is information adequate?" }, { id: 47, text: "(UC) Is exposure to adverse weather conditions avoided/managed?" }],
                        page3Options: [{ id: 1, text: "Is physical/physiological capability adequate?", subOptions: ["Inappropriate height/weight/size/strength/reach, etc", "Restricted range of body movement", "Limited ability/inability to sustain body positions", "Substance sensitivity/allergy", "Sensitivities to sensory extreme (temperature/sound/etc.)", "Vision deficiency", "Hearing deficiency", "Other sensory deficiency (touch/taste/smell/balance)", "Respiratory incapacity", "Other permanent physical disability", "Temporary disability"] }, { id: 2, text: "Is mental/psychological capability adequate?", subOptions: ["Fears and phobias", "Emotional disturbance", "Mental Illness", "Intelligence level", "Inability to comprehend", "Poor coordination", "Slow reaction time", "Low mechanical aptitude", "Low learning aptitude", "Memory failure/lapse"] }, { id: 3, text: "Is physical/physiological stress well-managed?", subOptions: ["Injury or illness", "Fatigue due to task load or duration", "Fatigue due to lack of rest", "Fatigue due to sensory overload", "Exposure to health hazard", "Exposure to temperature extreme", "Oxygen deficiency", "Atmospheric pressure variation", "Constrained movement", "Blood sugar insufficiency", "Alcohol/Drugs/Other Self Imposed Stress"] }, { id: 4, text: "Is mental/psychological stress well-managed?", subOptions: ["Emotional overload", "Fatigue due to mental task load or speed", "Extreme judgment/decision demands", "Routine/monotony/boredom/overly routine tasks", "Extreme concentration/perception demands", "\"Meaningless\"/\"degrading\" activities", "Confusing directions/demands", "Conflicting demands/directions", "Preoccupation with problems/Distraction by concern", "Frustration", "Mental illness"] }, { id: 5, text: "Is competence sufficient?", subOptions: ["Inadequate experience", "Inadequate orientation/induction", "Inadequate initial training", "Inadequate update/refresher training", "Misunderstood instruction/information", "Lack of situational awareness/risk perception/risk awareness", "Inadequate initial instruction/skill training", "Inadequate practice", "Infrequent performance", "Inadequate coaching", "Inadequate review instruction"] }, { id: 6, text: "Is motivation proper?", subOptions: ["Improper performance/behavior is tolerated/rewarded", "Proper performance/behavior is discouraged/punished", "Lack of incentive", "Improper production incentive", "Improper Cost Reduction Incentive", "Excessive frustration", "Inappropriate aggression", "Improper attempt to save time/effort", "Improper attempt to avoid discomfort", "Improper attempt to gain attention", "Inadequate discipline", "Inappropriate peer pressure", "Improper leadership example", "Inadequate performance feedback", "Inadequate reinforcement of proper behavior", "Abuse (intentionally)", "Misuse (unintentionally)"] }, { id: 7, text: "Is the organizational structure clear?", subOptions: ["Unclear/conflicting reporting relationship", "Unclear/conflicting assignment of function/role", "Unclear/conflicting accountability/responsibility/task"] }, { id: 8, text: "Is leadership adequate?", subOptions: ["Inadequate HSEQ/asset strategy", "Inadequate leadership development", "Inadequate delegation", "Inadequate standards", "Inadequate communication/ implementation of policy/ procedure/ practice", "Conflicting policy/procedure/practice", "Inadequate work/process planning/programming", "Condone deviation from policy/procedure/practice", "Condone misuse of equipment/tool", "Condone improper/inappropriate behavior", "Inadequate management information", "Inadequate monitoring/closure of audit actions"] }, { id: 9, text: "Is supervision/coaching adequate?", subOptions: ["Inadequate instruction/orientation/training", "Inadequate information documents in supervision/coaching", "Lack of supervisory/management job knowledge", "Inadequate match between qualifications and job/task requirements", "Inadequate performance measurement and evaluation", "Inadequate performance feedback"] }, { id: 10, text: "Is change managed effectively?", subOptions: ["Inadequate hazard identification/risk evaluation in design", "Inadequate identification of failure mode", "Inadequate evaluation of customer/stakeholder requirement", "Inadequate identification of legal requirement", "Inadequate consideration of human/ergonomic factor in design", "Inadequate design process/standard/specification/criterial", "Inadequate process control automation", "Inadequate (technical) standard/specification or absence thereof", "Inadequate review of project risk", "Inadequate monitoring of construction/fabrication/assembly", "Inadequate assessment of operational readiness", "Inadequate commissioning/handover process", "Inadequate monitoring of initial operation", "Inadequate management of change process"] }, { id: 11, text: "Is supply chain management adequate?", subOptions: ["Inadequate specification on requisition/purchase order", "Inadequate research on material/equipment/tool/supply/etc", "Inadequate specification to vendor", "Inadequate mode/route of shipment", "Inadequate communication of information about hazards", "Inadequate receiving inspection/acceptance", "Improper handling of material", "Improper storage of material", "Improper transporting of material", "Inadequate shelf life/validation for re-use of materials/equipment", "Inadequate identification of material", "Improper salvage/waste disposal", "Inadequate selection of contractor/supplier"] }, { id: 12, text: "Is maintenance/inspection adequate?", subOptions: ["Inadequate assessment of preventive maintenance needs", "Inadequate preventive lubrication and servicing", "Inadequate adjustment/assembly", "Inadequate preventive cleaning/resurfacing", "Inadequate communication of corrective maintenance needs", "Inadequate scheduling of maintenance work", "Inadequate assessment of repair needs", "Inadequate parts substitution/replacement", "Inadequate inspection method/interval", "Unable to inspect"] }, { id: 13, text: "Is wear/tear within acceptable limits?", subOptions: ["Inadequate planning of use", "Improper decision on extension of service life", "Inadequate inspection/monitoring", "Improper loading/rate of use", "Used for wrong purpose/task/activity"] }, { id: 14, text: "Are tools/equipment/machinery/devices adequate?", subOptions: ["Inadequate assessment of needs and risks", "Inadequate consideration of human factors/ergonomics", "Inadequate (supplier) standard/specification", "Incorrect measurement/detection/(process) control", "Inadequate availability of tool/equipment/machinery/device", "Inadequate inspection/repair/maintenance", "Inadequate adjustment/calibration", "Inadequate removal and replacement of unsuitable items"] }, { id: 15, text: "Is product/service design effective?", subOptions: ["Inadequate assessment of needs and risks", "Inadequate product/service standard/specification/concession system", "Inadequate product/service design/development", "Inadequate product/service standard", "Inadequate product/service design validation", "Inadequate product/service design verification", "Inadequate product/service planning", "Inadequate product/service quality verification"] }, { id: 16, text: "Are work/production standards adequate?", subOptions: ["Inadequate identification of requirements (regulatory/industry code/permit-to-operate)", "Inadequate risk identification/evaluation in development of standard", "Inadequate standard from supplier/contractor", "Inadequate coordination with process design when developing standard", "Inadequate employee involvement in developing standard", "Conflicting standards/improper prioritization of standards", "Inadequate publication of standard", "Inadequate distribution of standard", "Inadequate translation of appropriate language", "Improper use of language", "Inadequate training of standard", "Inadequate reinforcing of standard with signs, color codes and job aids", "Inadequate monitoring of standard compliance"] }, { id: 17, text: "Is communication/information effective?", subOptions: ["Inadequate information handling", "Unclear information", "Inadequate transfer of information between processes/organizational units", "Inadequate transfer of information with client/stakeholder", "Inadequate transfer of information with authorities", "Inadequate transfer of information with suppliers/contractors/third parties", "Inadequate communication structure", "Inadequate databases/information system", "Inadequate communication method/technique used"] }]
                    }
                }
            };
            const page2Mapping = { "Struck Against/Into (Running / Bumping / Colliding / Grounding / Crashing)":[1,2,3,4,5,6,7,14,16,17,19,22,23,24,25,26,32,33,34,35,38,41,47],"Struck By (Hit By Moving Object)":[1,2,3,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,28,32,33,34,35,41,47],"Fall from Elevation (Person/Equipment/Material)":[2,3,5,6,7,8,10,11,12,13,14,15,16,17,18,19,24,25,26,32,33,38,41,47],"Fall on Same Level (Slip and Fall/Trip Over)":[4,7,11,12,13,14,15,16,17,18,19,24,25,26,38,41,47],"Caught In, On, Between or Under":[1,2,3,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,24,25,26,27,28,29,32,33,34,35,38,41,44,46,47],"Contact with Temperature Extremes (Heat/Cold)":[1,2,3,5,6,7,8,9,10,12,14,15,16,17,18,19,25,26,27,28,29,30,31,32,33,34,35,38,41,43,44,45,46,47],"Contact with Electricity":[1,2,3,5,6,7,8,10,12,14,15,16,17,18,19,25,26,27,28,29,30,32,33,34,35,38,41,46,47],"Exposure to Noise":[2,3,5,6,7,8,10,12,14,15,16,17,18,19,25,26,27,28,29,32,33,34,35,38,39,41,44,46,47],"Exposure to Vibration":[1,2,3,5,6,7,8,11,12,14,15,16,17,18,19,25,26,27,28,29,30,32,34,35,38,41,42,46,47],"Exposure to Ionising Radiation":[1,2,3,5,6,7,8,10,12,14,15,16,17,18,19,25,26,27,28,29,32,33,34,35,36,37,38,40,41,43,45,46,47],"Mechanical Overstress (by Overload/Overpressure)":[1,2,3,4,5,6,7,8,9,11,12,13,14,17,18,25,26,28,29,31,34,35,42,43,44,46,47],"Contact with Hazardous Substance/Dose":[1,2,3,5,6,7,8,9,10,11,12,13,14,15,16,17,18,25,26,27,28,29,30,31,32,33,34,35,37,38,41,44,45,47],"Loss of Primary Containment":[1,2,3,5,6,7,8,9,11,12,13,15,16,17,18,19,25,26,27,28,29,30,31,32,34,35,37,38,42,43,44,47],"Environmental Release (to Air/Water/Soil)":[1,2,3,4,5,6,7,8,9,11,17,18,19,20,21,25,26,27,28,29,30,31,32,34,35,37,38,43,44,46,47],"Fire (Pool Fire/Jet Fire/Flash Fire)":[1,2,3,4,5,6,7,8,9,11,12,13,14,15,16,17,18,19,22,23,25,26,27,28,29,30,31,32,35,36,37,38,40,43,44,45,46,47],"Explosion (Vapour Cloud/Dust/Pressure Burst/BLEVE)":[1,2,3,4,5,6,7,8,9,11,15,16,17,18,20,21,22,23,25,26,27,28,29,30,31,32,35,36,37,38,40,43,44,45,46,47],"Failure of Mechanical Equipment":[1,4,6,9,11,12,13,17,18,25,26,28,29,30,35,37,42,43,44,46,47],"Failure of Electrical System":[1,4,6,9,11,12,13,17,25,26,28,29,30,35,37,42,43,45,46,47],"Failure of Instrumentation/Logic/Loop":[1,4,5,6,9,11,12,13,17,25,26,28,29,30,35,37,42,43,46,47],"Failure of Civil Structure":[1,2,3,4,5,6,7,9,11,12,14,17,18,25,26,28,29,30,34,35,38,42,43,44,46,47],"Abnormal Operation/Process Disturbance":[1,2,3,5,6,7,8,9,11,12,14,16,17,18,19,25,26,27,28,29,30,31,35,37,38,40,42,43,44,46],"Unstable process/reaction":[1,2,3,5,6,7,8,9,11,12,13,14,16,17,18,19,25,26,27,28,29,30,31,34,35,38,40,42,43,44,46],"Customers/Stakeholders Complaints":[1,2,5,6,7,8,9,10,11,12,13,15,16,17,19,20,21,25,26,27,28,29,30,31,35,38,39,40,41,42,46,47],"Act of Violence":[15,16,17,18,19,22,23,32,35]};
            const page3Mapping = { 1:[2,4,5,6,7,8,9,14,15,16,17],2:[1,2,3,4,5,6,7,8,9,11,13,16,17],3:[1,2,3,4,5,6,8,9,11,13,16,17],4:[2,3,4,5,6,8,9,10,14,15,16],5:[2,4,5,6,7,8,9,10,12,17],6:[2,3,4,5,6,8,9,10,11,12,13,14,15,16,17],7:[1,2,3,4,5,6,7,8,9,10,11,13,14,15,16,17],8:[3,4,5,6,7,8,9,10,12,13,14,15,16,17],9:[4,5,6,7,8,9,10,11,12,13,14,15,16,17],10:[1,2,3,4,5,6,8,9,11,12,13,14,15,16,17],11:[1,2,3,4,5,6,8,9,10,11,12,13,14,15,16],12:[1,2,3,4,5,6,8,9,10,11,12,14,15,16],13:[1,2,3,4,5,6,8,9,10,11,12,14,15,16],14:[1,2,3,4,5,6,10,14,15,16,17],15:[2,3,4,5,6,7,8,9,16],16:[1,2,3,4,5,6,8,9,16],17:[1,2,3,4,5,6,7,8,9,11,16],18:[3,4,5,6,7,8,9,10,12,16],19:[6,7,8,9,10,11,16,17],20:[4,5,6,7,8,9,10,11,12,13,14,15,16,17],21:[4,5,6,7,8,9,10,11,12,13,14,15,16,17],22:[3,4,6,8,9,11,16,17],23:[5,6,8,11,12,16,17],24:[10,12,13,14,16,17],25:[8,9,10,11,12,13,14,15],26:[3,4,5,6,9,10,11,12,13,14,16,17],27:[8,10,11,12,13,14,15,16],28:[1,2,3,4,5,6,8,9,10,12,13,14,15,16,17],29:[1,2,3,4,5,6,8,9,10,12,13,14,15,16,17],30:[8,9,10,11,12,13,14,15],31:[8,9,10,11,12,13,14,15,16,17],32:[5,8,9,10,11,12,13,14,15],33:[5,6,8,9,10,11,12,13,14,15],34:[8,9,11,16],35:[7,8,9,10,11,12,13,14,15,17],36:[5,6,7,8,9,10,11,12,13,14,15],37:[5,6,7,8,9,10,11,12,13,14,15,16,17],38:[6,7,8,9,10,12,16,17],39:[8,9,10,11,12,13,14,15,16,17],40:[8,9,10,11,12,13,14,15,16,17],41:[8,9,10,11,12,13,14,15,16,17],42:[6,8,9,10,11,12,13,14,15,16,17],43:[6,8,9,10,11,12,13,14,15,16,17],44:[6,8,9,10,11,12,13,14,15,16,17],45:[8,9,10,11,12,13,14,15,16,17],46:[5,8,9,10,11,12,17],47:[5,6,8,9,10,12,13,14,15,16,17] };
            
            // === STATE & DOM ===
            let currentLang;
            let APP_DATA;
            let currentPage = 1;
            const totalPages = 5;
            let formData = { description: '', page1Selections: [], page2Data: {}, page3Data: {}, page4Data: {} };

            const pages = document.querySelectorAll('.page');
            const nextBtn = document.getElementById('next-btn');
            const backBtn = document.getElementById('back-btn');
            const resetBtn = document.getElementById('reset-btn');
            const stepIndicator = document.getElementById('step-indicator');
            const page1OptionsContainer = document.getElementById('page-1-options');
            const descriptionTextarea = document.getElementById('description');
            const validationModal = document.getElementById('validation-modal');
            const modalMessage = document.getElementById('modal-message');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const btnLangId = document.getElementById('btn-lang-id');
            const btnLangEn = document.getElementById('btn-lang-en');
            
            // === FUNCTIONS ===

            function setLanguage(lang, isInitialLoad = false) {
                currentLang = lang;
                localStorage.setItem('appLang', lang);
                APP_DATA = LANG_PACKS[lang].appData;

                const ui = LANG_PACKS[lang].ui;
                document.documentElement.lang = lang;
                document.getElementById('page-title').textContent = ui.pageTitle;
                document.getElementById('main-header').textContent = ui.mainHeader;
                document.getElementById('main-subtitle').textContent = ui.mainSubtitle;
                
                document.getElementById('p1-header').textContent = ui.p1.header;
                document.getElementById('p1-subtitle').textContent = ui.p1.subtitle;
                document.getElementById('p1-desc-label').textContent = ui.p1.descLabel;
                if(!isInitialLoad || descriptionTextarea.value === '') {
                    descriptionTextarea.placeholder = ui.p1.descPlaceholder;
                }
                
                backBtn.textContent = ui.buttons.back;
                resetBtn.textContent = ui.buttons.reset;
                closeModalBtn.textContent = ui.buttons.close;
                document.getElementById('modal-header').textContent = ui.modalHeader;

                btnLangId.classList.toggle('active', lang === 'id');
                btnLangEn.classList.toggle('active', lang === 'en');

                const currentRenderFunction = window[`renderPage${currentPage}`];
                if (typeof currentRenderFunction === 'function') {
                    currentRenderFunction();
                }
                updateNavigation();
            }

            function showModal(message) {
                modalMessage.textContent = message;
                validationModal.classList.remove('hidden');
                validationModal.classList.add('flex');
            }

            function hideModal() {
                validationModal.classList.add('hidden');
                validationModal.classList.remove('flex');
            }

            function updateNavigation() {
                stepIndicator.textContent = LANG_PACKS[currentLang].ui.stepIndicator(currentPage, totalPages);
                backBtn.classList.toggle('invisible', currentPage === 1);
                resetBtn.classList.toggle('invisible', currentPage === 1);

                if (currentPage === totalPages) {
                    nextBtn.textContent = LANG_PACKS[currentLang].ui.buttons.finish;
                    nextBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    nextBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                } else {
                    nextBtn.textContent = LANG_PACKS[currentLang].ui.buttons.next;
                    nextBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    nextBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                }
            }
            
            function showPage(pageNum) {
                pages.forEach((page, index) => {
                    page.classList.toggle('hidden', index + 1 !== pageNum);
                });
                currentPage = pageNum;
                const renderFunction = window[`renderPage${currentPage}`];
                if (typeof renderFunction === 'function') {
                    setTimeout(renderFunction, 0);
                }
                updateNavigation();
                window.scrollTo(0, 0);
            }

            // === RENDER FUNCTIONS ===

            window.renderPage1 = function() {
                page1OptionsContainer.innerHTML = '';
                APP_DATA.page1Options.forEach((option, index) => {
                    const isChecked = formData.page1Selections.includes(index);
                    const itemHTML = `
                        <div class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition">
                            <input id="p1-opt-${index}" type="checkbox" data-index="${index}" ${isChecked ? 'checked' : ''} class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="p1-opt-${index}" class="ml-3 text-sm font-medium text-gray-700">${option}</label>
                        </div>
                    `;
                    page1OptionsContainer.insertAdjacentHTML('beforeend', itemHTML);
                });
            }

            function createPageLayout(pageNum, containerId) {
                const pageContainer = document.getElementById(`page-${pageNum}`);
                const ui = LANG_PACKS[currentLang].ui;
                pageContainer.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-6 text-blue-600">${ui[`p${pageNum}`].header}</h2>
                    <div id="description-display-p${pageNum}" class="sticky-header bg-white/95 backdrop-blur-sm py-4 border-b border-gray-200 -mx-6 px-6 md:-mx-8 md:px-8">
                        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <h3 class="font-bold text-gray-700 mb-2">${ui[`p${pageNum}`].descTitle}</h3>
                            <p class="text-gray-600 text-sm max-h-24 overflow-y-auto"></p>
                        </div>
                    </div>
                    <div id="${containerId}" class="mt-6"></div>
                `;
                const descP = pageContainer.querySelector(`#description-display-p${pageNum} p`);
                descP.textContent = formData.description || `(${ui.report.noAnalysis})`;
                return document.getElementById(containerId);
            }

            window.renderPage2 = function() {
                const container = createPageLayout(2, 'page-2-sub-options-container');
                const ui = LANG_PACKS[currentLang].ui;
                const descHeight = document.getElementById('description-display-p2').offsetHeight;

                formData.page1Selections.forEach(p1Index => {
                    const sectionContainer = document.createElement('div');
                    sectionContainer.className = 'flex border-t first:border-t-0';
                    
                    const p1Text = APP_DATA.page1Options[p1Index];
                    const p1EnglishKey = LANG_PACKS.en.appData.page1Options[p1Index];
                    const subOptionIDs = page2Mapping[p1EnglishKey] || [];
                    const subOptions = APP_DATA.page2Options.filter(opt => subOptionIDs.includes(opt.id));

                    sectionContainer.innerHTML = `
                        <div class="w-16 md:w-20 flex-shrink-0">
                            <div class="sticky-sidebar flex items-center justify-center" style="top: ${descHeight}px; height: calc(100vh - ${descHeight}px);">
                                <h3 class="text-base font-bold text-gray-600 vertical-text text-center p-2 bg-gray-100 rounded-md">${p1Text}</h3>
                            </div>
                        </div>
                        <div class="flex-grow p-4 border-l space-y-4">
                            ${subOptions.map(subOpt => {
                                const savedData = formData.page2Data[p1Index]?.[subOpt.id] || { choice: 'NA', comment: '' };
                                return `
                                <div class="p-4 border border-gray-200 rounded-lg bg-white" data-p1-index="${p1Index}" data-p2-id="${subOpt.id}">
                                    <p class="font-medium text-gray-700 mb-3">${subOpt.text}</p>
                                    <div class="radio-group flex flex-wrap gap-2">
                                        <input type="radio" id="yes-${p1Index}-${subOpt.id}" name="choice-${p1Index}-${subOpt.id}" value="YES" ${savedData.choice === 'YES' ? 'checked' : ''} class="hidden">
                                        <label for="yes-${p1Index}-${subOpt.id}" class="cursor-pointer px-4 py-2 border rounded-md font-semibold text-sm">${ui.radio.yes}</label>
                                        <input type="radio" id="no-${p1Index}-${subOpt.id}" name="choice-${p1Index}-${subOpt.id}" value="NO" ${savedData.choice === 'NO' ? 'checked' : ''} class="hidden">
                                        <label for="no-${p1Index}-${subOpt.id}" class="cursor-pointer px-4 py-2 border rounded-md font-semibold text-sm">${ui.radio.no}</label>
                                        <input type="radio" id="na-${p1Index}-${subOpt.id}" name="choice-${p1Index}-${subOpt.id}" value="NA" ${savedData.choice === 'NA' ? 'checked' : ''} class="hidden">
                                        <label for="na-${p1Index}-${subOpt.id}" class="cursor-pointer px-4 py-2 border rounded-md font-semibold text-sm">${ui.radio.na}</label>
                                    </div>
                                    <div class="comment-container mt-3 ${savedData.choice === 'YES' || savedData.choice === 'NO' ? 'visible' : ''}">
                                        <textarea class="comment-box w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="${ui.comments.commentPlaceholder}" ${savedData.choice === 'YES' || savedData.choice === 'NO' ? 'required' : ''}>${savedData.comment}</textarea>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                    container.appendChild(sectionContainer);
                });
            }
            
            window.renderPage3 = function() {
                const container = createPageLayout(3, 'page-3-sub-options-container');
                const ui = LANG_PACKS[currentLang].ui;
                const descHeight = document.getElementById('description-display-p3').offsetHeight;

                formData.page1Selections.forEach(p1Index => {
                    const p1Text = APP_DATA.page1Options[p1Index];
                    const directCausesForEvent = formData.page2Data[p1Index] || {};
                    let hasContentForSection = false;

                    const rightPanel = document.createElement('div');
                    rightPanel.className = 'flex-grow p-4 border-l space-y-4';

                    Object.keys(directCausesForEvent).forEach(p2Id => {
                        const directCauseData = directCausesForEvent[p2Id];
                        if (directCauseData.choice === 'NO') {
                            hasContentForSection = true;
                            const directCauseInfo = APP_DATA.page2Options.find(opt => opt.id == p2Id);
                            const rootCauseIDs = page3Mapping[p2Id] || [];
                            const rootCauses = APP_DATA.page3Options.filter(opt => rootCauseIDs.includes(opt.id));
                            
                            const directCauseSection = document.createElement('div');
                            directCauseSection.innerHTML = `
                                <div class="sticky bg-white/95 backdrop-blur-sm py-3" style="top: ${descHeight}px;">
                                    <div class="p-3 border border-blue-200 rounded-lg bg-blue-50/50">
                                        <p class="font-semibold text-blue-800">${ui.report.directCause}:</p>
                                        <p class="text-sm text-gray-700">${directCauseInfo.text}</p>
                                        <p class="mt-1 text-xs text-gray-500 italic">${ui.report.comment} ${directCauseData.comment}</p>
                                    </div>
                                </div>
                                ${rootCauses.map(rootCause => {
                                    const savedData = formData.page3Data?.[p1Index]?.[p2Id]?.[rootCause.id] || { choice: 'NA', subChoices: {} };
                                    return `
                                    <div class="p-3 mt-2 ml-4 border-l-2 border-blue-200 bg-white rounded-r-lg" data-p1-index="${p1Index}" data-p2-id="${p2Id}" data-p3-id="${rootCause.id}">
                                        <p class="font-medium text-gray-700 text-sm mb-3">${rootCause.text}</p>
                                        <div class="radio-group flex flex-wrap gap-2">
                                            <input type="radio" id="yes-${p1Index}-${p2Id}-${rootCause.id}" name="choice-${p1Index}-${p2Id}-${rootCause.id}" value="YES" ${savedData.choice === 'YES' ? 'checked' : ''} class="hidden">
                                            <label for="yes-${p1Index}-${p2Id}-${rootCause.id}" class="cursor-pointer px-3 py-1.5 border rounded-md font-semibold text-xs">${ui.radio.yes}</label>
                                            <input type="radio" id="no-${p1Index}-${p2Id}-${rootCause.id}" name="choice-${p1Index}-${p2Id}-${rootCause.id}" value="NO" ${savedData.choice === 'NO' ? 'checked' : ''} class="hidden">
                                            <label for="no-${p1Index}-${p2Id}-${rootCause.id}" class="cursor-pointer px-3 py-1.5 border rounded-md font-semibold text-xs">${ui.radio.no}</label>
                                            <input type="radio" id="na-${p1Index}-${p2Id}-${rootCause.id}" name="choice-${p1Index}-${p2Id}-${rootCause.id}" value="NA" ${savedData.choice === 'NA' ? 'checked' : ''} class="hidden">
                                            <label for="na-${p1Index}-${p2Id}-${rootCause.id}" class="cursor-pointer px-3 py-1.5 border rounded-md font-semibold text-xs">${ui.radio.na}</label>
                                        </div>
                                        <div class="sub-options-container mt-3 pl-4 border-t pt-3 ${savedData.choice === 'NO' ? 'visible' : ''}">
                                            <div class="space-y-2">
                                            ${rootCause.subOptions.map((subOpt, subIndex) => {
                                                const isChecked = savedData.subChoices && savedData.subChoices[subIndex] !== undefined;
                                                const comment = isChecked ? savedData.subChoices[subIndex] : '';
                                                return `
                                                <div class="sub-option-item flex flex-col sm:flex-row items-start space-y-2 sm:space-y-0 sm:space-x-2 py-1">
                                                    <div class="flex items-center w-full sm:w-1/2 flex-shrink-0">
                                                        <input type="checkbox" data-sub-index="${subIndex}" id="subopt-${p1Index}-${p2Id}-${rootCause.id}-${subIndex}" ${isChecked ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2">
                                                        <label for="subopt-${p1Index}-${p2Id}-${rootCause.id}-${subIndex}" class="text-xs text-gray-700">${subOpt}</label>
                                                    </div>
                                                    <div class="comment-container w-full sm:w-1/2 ${isChecked ? 'visible' : ''}">
                                                        <textarea class="w-full p-1 border border-gray-300 rounded-md text-xs" rows="2" placeholder="${ui.comments.subCommentPlaceholder}" ${isChecked ? 'required' : ''}>${comment}</textarea>
                                                    </div>
                                                </div>`;
                                            }).join('')}
                                            </div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            `;
                            rightPanel.appendChild(directCauseSection);
                        }
                    });

                    if (hasContentForSection) {
                        const sectionContainer = document.createElement('div');
                        sectionContainer.className = 'flex border-t first:border-t-0';
                        sectionContainer.innerHTML = `
                            <div class="w-16 md:w-20 flex-shrink-0">
                                <div class="sticky-sidebar flex items-center justify-center" style="top: ${descHeight}px; height: calc(100vh - ${descHeight}px);">
                                    <h3 class="text-base font-bold text-gray-600 vertical-text text-center p-2 bg-gray-100 rounded-md">${p1Text}</h3>
                                </div>
                            </div>
                        `;
                        sectionContainer.appendChild(rightPanel);
                        container.appendChild(sectionContainer);
                    }
                });
            }

            window.renderPage4 = function() {
                const container = createPageLayout(4, 'page-4-sub-options-container');
                const ui = LANG_PACKS[currentLang].ui;
                const descHeight = document.getElementById('description-display-p4').offsetHeight;

                formData.page1Selections.forEach(p1Index => {
                    const p1Text = APP_DATA.page1Options[p1Index];
                    let hasContentForSection = false;
                    const rightPanel = document.createElement('div');
                    rightPanel.className = 'flex-grow p-4 border-l space-y-6';

                    const directCausesForEvent = formData.page2Data[p1Index] || {};
                    Object.keys(directCausesForEvent).forEach(p2Id => {
                        const rootCausesForDirectCause = formData.page3Data?.[p1Index]?.[p2Id] || {};
                        Object.keys(rootCausesForDirectCause).forEach(p3Id => {
                            const rootCauseData = rootCausesForDirectCause[p3Id];
                            if (rootCauseData.choice === 'NO' && rootCauseData.subChoices && Object.keys(rootCauseData.subChoices).length > 0) {
                                hasContentForSection = true;
                                const directCauseInfo = APP_DATA.page2Options.find(opt => opt.id == p2Id);
                                const rootCauseInfo = APP_DATA.page3Options.find(opt => opt.id == p3Id);
                                const savedData = formData.page4Data?.[p1Index]?.[p2Id]?.[p3Id] || { correctiveAction: '', pic: '', targetDate: '' };
                                
                                const subChoicesList = Object.entries(rootCauseData.subChoices).map(([subIndex, comment]) => {
                                    const subChoiceText = rootCauseInfo.subOptions[subIndex];
                                    return `<li class="text-xs text-gray-600"><span class="font-semibold">${subChoiceText}:</span> ${comment}</li>`;
                                }).join('');

                                const correctiveActionSection = document.createElement('div');
                                correctiveActionSection.className = "p-4 border border-green-200 rounded-lg bg-green-50/50";
                                correctiveActionSection.dataset.p1Index = p1Index;
                                correctiveActionSection.dataset.p2Id = p2Id;
                                correctiveActionSection.dataset.p3Id = p3Id;
                                correctiveActionSection.innerHTML = `
                                    <div class="mb-4">
                                        <p class="text-xs text-gray-500">${ui.report.directCause}</p>
                                        <p class="font-semibold text-sm text-gray-800">${directCauseInfo.text}</p>
                                        <p class="text-xs text-gray-500 mt-2">${ui.report.rootCause}</p>
                                        <p class="font-semibold text-sm text-gray-800">${rootCauseInfo.text}</p>
                                        <p class="text-xs text-gray-500 mt-2">${ui.report.subChoiceDetails}</p>
                                        <ul class="list-disc list-inside mt-1">${subChoicesList}</ul>
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">${ui.p4.correctiveAction}</label>
                                            <textarea class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" required>${savedData.correctiveAction}</textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">${ui.p4.pic}</label>
                                            <input type="text" value="${savedData.pic}" class="w-full p-2 border border-gray-300 rounded-md text-sm" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">${ui.p4.targetDate}</label>
                                            <input type="date" value="${savedData.targetDate}" class="w-full p-2 border border-gray-300 rounded-md text-sm" required>
                                        </div>
                                    </div>
                                `;
                                rightPanel.appendChild(correctiveActionSection);
                            }
                        });
                    });

                    if (hasContentForSection) {
                        const sectionContainer = document.createElement('div');
                        sectionContainer.className = 'flex border-t first:border-t-0';
                        sectionContainer.innerHTML = `
                            <div class="w-16 md:w-20 flex-shrink-0">
                                <div class="sticky-sidebar flex items-center justify-center" style="top: ${descHeight}px; height: calc(100vh - ${descHeight}px);">
                                    <h3 class="text-base font-bold text-gray-600 vertical-text text-center p-2 bg-gray-100 rounded-md">${p1Text}</h3>
                                </div>
                            </div>
                        `;
                        sectionContainer.appendChild(rightPanel);
                        container.appendChild(sectionContainer);
                    }
                });
            }

            window.renderPage5 = function() {
                const pageContainer = document.getElementById('page-5');
                const ui = LANG_PACKS[currentLang].ui;
                pageContainer.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-6 text-blue-600">${ui.p5.header}</h2>
                    <div id="final-report" class="space-y-6"></div>
                    <div class="mt-8 pt-6 border-t flex flex-col sm:flex-row gap-4 justify-end">
                        <button id="btn-send-email" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                            <span>${ui.buttons.sendEmail}</span>
                        </button>
                        <button id="btn-download-word" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            <span>${ui.buttons.downloadWord}</span>
                        </button>
                    </div>
                `;
                document.getElementById('btn-send-email').onclick = () => alert(LANG_PACKS[currentLang].alerts.email);
                document.getElementById('btn-download-word').onclick = () => {
                    const reportHtml = document.getElementById('final-report').innerHTML;
                    const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial,sans-serif;font-size:12px;}h3,h4{margin-bottom:4px;}p{margin-top:2px;margin-bottom:2px;}ul{margin-top:2px;padding-left:20px;}</style></head><body>${reportHtml}</body></html>`;
                    const converted = htmlDocx.asBlob(fullHtml);
                    const url = URL.createObjectURL(converted);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'laporan_insiden.docx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                const reportContainer = document.getElementById('final-report');
                let summaryMapHTML = `<div class="p-4 border rounded-lg bg-gray-50"><h3 class="font-bold text-xl mb-2 text-gray-800">${ui.report.summaryMapTitle}</h3><ul class="list-disc list-inside space-y-2">`;
                summaryMapHTML += `<li><span class="font-semibold">${ui.report.incidentDesc}:</span> ${formData.description}</li>`;

                formData.page1Selections.forEach(p1Index => {
                    const p1Text = APP_DATA.page1Options[p1Index];
                    summaryMapHTML += `<li><span class="font-semibold">${ui.report.eventType}:</span> ${p1Text}<ul class="list-disc list-inside ml-6">`;

                    const directCausesForEvent = formData.page2Data[p1Index] || {};
                    Object.keys(directCausesForEvent).forEach(p2Id => {
                        if (directCausesForEvent[p2Id].choice === 'NO') {
                            const directCauseInfo = APP_DATA.page2Options.find(opt => opt.id == p2Id);
                            summaryMapHTML += `<li><span class="font-semibold">${ui.report.directCause}:</span> ${directCauseInfo.text}<ul class="list-disc list-inside ml-6">`;

                            const rootCausesForDirectCause = formData.page3Data?.[p1Index]?.[p2Id] || {};
                            Object.keys(rootCausesForDirectCause).forEach(p3Id => {
                                const rootCauseData = rootCausesForDirectCause[p3Id];
                                if (rootCauseData.choice === 'NO' && Object.keys(rootCauseData.subChoices).length > 0) {
                                    const rootCauseInfo = APP_DATA.page3Options.find(opt => opt.id == p3Id);
                                    summaryMapHTML += `<li><span class="font-semibold">${ui.report.rootCause}:</span> ${rootCauseInfo.text}<ul class="list-disc list-inside ml-6">`;
                                    Object.keys(rootCauseData.subChoices).forEach(subIndex => {
                                        summaryMapHTML += `<li>${rootCauseInfo.subOptions[subIndex]}</li>`;
                                    });
                                    summaryMapHTML += `</ul></li>`;
                                }
                            });
                            summaryMapHTML += `</ul></li>`;
                        }
                    });
                    summaryMapHTML += `</ul></li>`;
                });
                summaryMapHTML += `</ul></div>`;

                let detailedReportHTML = `<div class="p-4 border rounded-lg bg-gray-50 mt-6"><h3 class="font-bold text-xl mb-2 text-gray-800">${ui.report.analysisTitle}</h3></div>`;
                let analysisHTML = '';

                formData.page1Selections.forEach(p1Index => {
                    let eventHTML = `<div class="mt-4 p-4 border rounded-lg"><h4 class="font-bold text-lg text-blue-700">${ui.report.eventType}: ${APP_DATA.page1Options[p1Index]}</h4>`;
                    let directCauseAdded = false;
                    const directCausesForEvent = formData.page2Data[p1Index] || {};
                    Object.keys(directCausesForEvent).forEach(p2Id => {
                        const directCauseData = directCausesForEvent[p2Id];
                        if (directCauseData.choice === 'NO') {
                            directCauseAdded = true;
                            const directCauseInfo = APP_DATA.page2Options.find(opt => opt.id == p2Id);
                            eventHTML += `<div class="mt-3 ml-4 pl-4 border-l-2 border-blue-200"><p class="font-semibold text-gray-800">${ui.report.directCause}: ${directCauseInfo.text}</p><p class="text-sm text-gray-500 italic">${ui.report.comment} ${directCauseData.comment}</p>`;
                            
                            const rootCausesForDirectCause = formData.page3Data?.[p1Index]?.[p2Id] || {};
                            Object.keys(rootCausesForDirectCause).forEach(p3Id => {
                                const rootCauseData = rootCausesForDirectCause[p3Id];
                                if (rootCauseData.choice === 'NO' && Object.keys(rootCauseData.subChoices).length > 0) {
                                    const rootCauseInfo = APP_DATA.page3Options.find(opt => opt.id == p3Id);
                                    const subChoicesList = Object.entries(rootCauseData.subChoices).map(([subIndex, comment]) => `
                                        <li class="text-sm text-gray-600"><span class="font-semibold">${rootCauseInfo.subOptions[subIndex]}:</span> ${comment}</li>`).join('');
                                    eventHTML += `<div class="mt-3 ml-4 pl-4 border-l-2 border-gray-300"><p class="font-semibold text-gray-700">${ui.report.rootCause}: ${rootCauseInfo.text}</p><p class="text-sm font-semibold text-gray-600 mt-2">${ui.report.subChoiceDetails}</p><ul class="list-disc list-inside mt-1">${subChoicesList}</ul>`;

                                    const correctiveActionData = formData.page4Data?.[p1Index]?.[p2Id]?.[p3Id];
                                    if (correctiveActionData) {
                                        eventHTML += `<div class="mt-3 p-3 rounded-md bg-green-50 border border-green-200">
                                            <p class="font-semibold text-green-800">${ui.report.correctiveAction}</p>
                                            <p class="text-sm text-gray-700">${correctiveActionData.correctiveAction}</p>
                                            <p class="text-xs text-gray-600 mt-2"><b>${ui.report.pic}</b> ${correctiveActionData.pic} | <b>${ui.report.target}</b> ${correctiveActionData.targetDate}</p>
                                        </div>`;
                                    }
                                    eventHTML += `</div>`;
                                }
                            });
                            eventHTML += `</div>`;
                        }
                    });
                    if (!directCauseAdded) eventHTML += `<p class="mt-2 text-sm text-gray-500">${ui.report.noDirectCause}</p>`;
                    eventHTML += `</div>`;
                    analysisHTML += eventHTML;
                });
                
                detailedReportHTML += analysisHTML || `<p>${ui.report.noAnalysis}</p>`;
                reportContainer.innerHTML = summaryMapHTML + detailedReportHTML;
            }

            // === DATA HANDLING ===
            
            function saveDataFromCurrentPage() {
                formData.description = descriptionTextarea.value;
                if (currentPage === 1) {
                    formData.page1Selections = Array.from(document.querySelectorAll('#page-1-options input:checked')).map(el => parseInt(el.dataset.index));
                } else if (currentPage === 2) {
                    document.querySelectorAll('#page-2-sub-options-container [data-p2-id]').forEach(el => {
                        const p1Index = parseInt(el.dataset.p1Index);
                        const p2Id = parseInt(el.dataset.p2Id);
                        const choice = el.querySelector('input[type="radio"]:checked')?.value || 'NA';
                        const comment = el.querySelector('.comment-box').value;
                        if (!formData.page2Data[p1Index]) formData.page2Data[p1Index] = {};
                        formData.page2Data[p1Index][p2Id] = { choice, comment };
                    });
                } else if (currentPage === 3) {
                    document.querySelectorAll('#page-3-sub-options-container [data-p3-id]').forEach(el => {
                        const p1Index = parseInt(el.dataset.p1Index);
                        const p2Id = parseInt(el.dataset.p2Id);
                        const p3Id = parseInt(el.dataset.p3Id);
                        const choice = el.querySelector('input[name^="choice-"]:checked')?.value || 'NA';
                        const subChoices = {};
                        if (choice === 'NO') {
                            el.querySelectorAll('.sub-option-item input[type="checkbox"]:checked').forEach(checkbox => {
                                const subIndex = parseInt(checkbox.dataset.subIndex);
                                const commentTextarea = checkbox.closest('.sub-option-item').querySelector('textarea');
                                subChoices[subIndex] = commentTextarea.value;
                            });
                        }
                        if (!formData.page3Data[p1Index]) formData.page3Data[p1Index] = {};
                        if (!formData.page3Data[p1Index][p2Id]) formData.page3Data[p1Index][p2Id] = {};
                        formData.page3Data[p1Index][p2Id][p3Id] = { choice, subChoices };
                    });
                } else if (currentPage === 4) {
                    document.querySelectorAll('#page-4-sub-options-container [data-p3-id]').forEach(el => {
                        const p1Index = parseInt(el.dataset.p1Index);
                        const p2Id = parseInt(el.dataset.p2Id);
                        const p3Id = parseInt(el.dataset.p3Id);
                        const correctiveAction = el.querySelector('textarea').value;
                        const pic = el.querySelectorAll('input')[0].value;
                        const targetDate = el.querySelectorAll('input')[1].value;
                        if (!formData.page4Data[p1Index]) formData.page4Data[p1Index] = {};
                        if (!formData.page4Data[p1Index][p2Id]) formData.page4Data[p1Index][p2Id] = {};
                        formData.page4Data[p1Index][p2Id][p3Id] = { correctiveAction, pic, targetDate };
                    });
                }
                localStorage.setItem('incidentFormData', JSON.stringify(formData));
            }

            function loadDataFromStorage() {
                const savedData = localStorage.getItem('incidentFormData');
                if (savedData) {
                    formData = JSON.parse(savedData);
                    descriptionTextarea.value = formData.description;
                }
            }

            function validateCurrentPage() {
                let isValid = true;
                let message = '';
                const validationText = LANG_PACKS[currentLang].validation;
                
                if (currentPage === 1) {
                    if (descriptionTextarea.value.trim() === '') {
                        isValid = false; message = validationText.descRequired;
                        descriptionTextarea.focus(); descriptionTextarea.classList.add('border-red-500', 'ring-red-500');
                    } else if (formData.page1Selections.length === 0) {
                        isValid = false; message = validationText.eventRequired;
                        descriptionTextarea.classList.remove('border-red-500', 'ring-red-500');
                    } else {
                        descriptionTextarea.classList.remove('border-red-500', 'ring-red-500');
                    }
                } else if (currentPage === 2 || currentPage === 3 || currentPage === 4) {
                    const requiredFields = document.querySelectorAll(`#page-${currentPage} textarea[required]`);
                    for (const field of requiredFields) {
                        if (field.value.trim() === '') {
                            isValid = false;
                            if(currentPage === 2) message = validationText.commentRequired;
                            if(currentPage === 3) message = validationText.subCommentRequired;
                            if(currentPage === 4) message = validationText.actionRequired;
                            field.focus(); field.classList.add('border-red-500', 'ring-red-500');
                            break;
                        }
                        field.classList.remove('border-red-500', 'ring-red-500');
                    }
                }

                if (!isValid) showModal(message);
                return isValid;
            }

            function resetForm() {
                formData = { description: '', page1Selections: [], page2Data: {}, page3Data: {}, page4Data: {} };
                localStorage.removeItem('incidentFormData');
                descriptionTextarea.value = '';
                showPage(1);
            }

            // === EVENT LISTENERS ===
            btnLangId.addEventListener('click', () => setLanguage('id'));
            btnLangEn.addEventListener('click', () => setLanguage('en'));

            nextBtn.addEventListener('click', () => {
                saveDataFromCurrentPage();
                if (!validateCurrentPage()) return;
                if (currentPage < totalPages) {
                    showPage(currentPage + 1);
                } else {
                    window.print();
                }
            });

            backBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    saveDataFromCurrentPage();
                    showPage(currentPage - 1);
                }
            });

            resetBtn.addEventListener('click', resetForm);

            document.getElementById('form-pages').addEventListener('change', (e) => {
                const target = e.target;
                
                if (target.type === 'radio') {
                    const parentP3 = target.closest('[data-p3-id]');
                    const parentP2 = target.closest('[data-p2-id]');

                    if (parentP3) { // Logic for Page 3 Radio Buttons
                        const subOptionsContainer = parentP3.querySelector('.sub-options-container');
                        if (subOptionsContainer) {
                            if (target.value === 'NO') {
                                subOptionsContainer.classList.add('visible');
                            } else {
                                subOptionsContainer.classList.remove('visible');
                                subOptionsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                                    cb.checked = false;
                                    cb.dispatchEvent(new Event('change', { bubbles: true }));
                                });
                            }
                        }
                    } else if (parentP2) { // Logic for Page 2 Radio Buttons
                        const commentContainer = parentP2.querySelector('.comment-container');
                        if (commentContainer) {
                            const commentBox = commentContainer.querySelector('textarea.comment-box');
                            if (commentBox) {
                                if (target.value === 'YES' || target.value === 'NO') {
                                    commentContainer.classList.add('visible');
                                    commentBox.setAttribute('required', 'true');
                                } else {
                                    commentContainer.classList.remove('visible');
                                    commentBox.removeAttribute('required');
                                }
                            }
                        }
                    }
                }

                if (target.type === 'checkbox' && target.closest('.sub-option-item')) {
                    const parentItem = target.closest('.sub-option-item');
                    const commentContainer = parentItem.querySelector('.comment-container');
                    if (commentContainer) {
                        const commentBox = commentContainer.querySelector('textarea');
                        if (commentBox) {
                            if (target.checked) {
                                commentContainer.classList.add('visible');
                                commentBox.setAttribute('required', 'true');
                                setTimeout(() => commentBox.focus(), 300);
                            } else {
                                commentContainer.classList.remove('visible');
                                commentBox.removeAttribute('required');
                                commentBox.classList.remove('border-red-500', 'ring-red-500');
                            }
                        }
                    }
                }
            });

            closeModalBtn.addEventListener('click', hideModal);

            // === INITIALIZATION ===
            const initialLang = localStorage.getItem('appLang') || 'id';
            loadDataFromStorage();
            setLanguage(initialLang, true);
            showPage(1);
        });
    </script>
</body>
</html>
